# Submit RenderDragon Public API

This document describes the public upload API exposed by this project, implemented in `src/app/api/uploadthing/` using UploadThing.

- Framework: Next.js App Router
- Library: `uploadthing/next`
- Base path: `/api/uploadthing`
- Endpoint key: `fileUploader` (defined in `ourFileRouter`)

The API supports image, PDF, and video uploads with server-side post-processing and optional Discord notifications.


## Overview
- You can upload files via the UploadThing client SDK (recommended) or through a raw HTTP flow.
- Optional authentication via a public API key in the `x-api-key` header.
- Optional `x-description` header to attach a short textual description to the upload (max ~1024 chars).
- On successful upload, the server returns a JSON payload containing the public `url` of the uploaded file.
- If `DISCORD_WEBHOOK_URL` is configured, a Discord embed is posted announcing the upload.


## Base URL
- For local development: `http://localhost:3000/api/uploadthing`
- For production: `https://<your-domain>/api/uploadthing`

All examples below assume you substitute the correct base URL for your environment.


## Authentication
- Header: `x-api-key: <PUBLIC_API_KEY>`
- The key is optional. If it is provided and does not match, the request fails with an error.
- If omitted, uploads from your internal app are still permitted.

Note: The current implementation validates the key in middleware and throws an error if invalid. Ensure you distribute the public key securely if you rely on it for gating usage.


## Metadata
- Header: `x-description: <short description>`
- The server truncates this to 1024 characters and includes it in the Discord embed and upload metadata.


## File Constraints
Configured in `src/app/api/uploadthing/core.ts` under `ourFileRouter.fileUploader`:

- image: max 256MB
- pdf: max 128MB
- video: max 1024MB

Adjust these constraints in code if needed.


## Endpoints and Methods
The Next.js route handler is generated by UploadThing:

- Path: `/api/uploadthing`
- Methods: `GET`, `POST`

The UploadThing protocol multiplexes multiple logical routes behind this single path. This project defines one logical route (aka endpoint key): `fileUploader`.


## Recommended: Upload via UploadThing SDK
UploadThing provides React components and a client SDK that handle the multi-step upload protocol for you.

### 1) Install (if building a client)
```bash
npm install uploadthing @uploadthing/react
```

### 2) Use the React dropzone (example)
```tsx
import { UploadDropzone } from "@uploadthing/react";
import type { OurFileRouter } from "@/app/api/uploadthing/core";
import "@uploadthing/react/styles.css";

export function Uploader() {
  return (
    <UploadDropzone<OurFileRouter>
      endpoint="fileUploader"
      input={{}} // optional
      headers={{
        "x-api-key": process.env.NEXT_PUBLIC_UPLOAD_API_KEY ?? "",
        "x-description": "My sample upload",
      }}
      onClientUploadComplete={(res) => {
        // res contains server returned data, including url
        console.log("Uploaded:", res);
      }}
      onUploadError={(error) => {
        console.error("Upload failed:", error);
      }}
    />
  );
}
```

### 3) Or programmatic client upload (Node/Browser)
```ts
// Pseudocode-ish: use @uploadthing/client or underlying fetches.
// The key is to target `/api/uploadthing` and specify route "fileUploader".
```

Using the SDK is strongly recommended to avoid dealing with the low-level presign/PUT/complete steps of UploadThing.


## Advanced: Raw HTTP Flow
If you cannot use the SDK, you can talk to the UploadThing route directly. The protocol is managed by UploadThing and may change between versions. The following outlines the typical flow used by UploadThing (simplified) and is provided as guidance only.

1) Initialize upload session (POST JSON)
```bash
curl -X POST \
  "https://<your-domain>/api/uploadthing" \
  -H "Content-Type: application/json" \
  -H "x-api-key: <PUBLIC_API_KEY>" \
  -H "x-description: Example upload via cURL" \
  --data '{
    "files": [
      {"name": "photo.png", "size": 123456, "type": "image/png"}
    ],
    "route": "fileUploader"
  }'
```
- Response: JSON including presigned upload URLs/fields per file (shape managed by UploadThing).

2) Upload file bytes to the returned presigned URL (usually a PUT to S3 or similar)
```bash
curl -X PUT \
  "<presigned_url_from_step_1>" \
  -H "Content-Type: image/png" \
  --data-binary @photo.png
```

3) Notify completion (if required by the response from step 1)
- Some UploadThing versions handle completion automatically when PUT succeeds; others require calling a completion URL. Follow the response from step 1.

4) Final server response
- The Next.js server `onUploadComplete` handler returns a JSON object like:
```json
{ "url": "https://utfs.io/f/abc123..." }
```


## Headers
- `x-api-key` (optional)
- `x-description` (optional; truncated to 1024 chars)

These headers are read in the middleware defined in `ourFileRouter.fileUploader.middleware`.


## Response Shape
On successful completion, the server returns JSON with the public URL of the uploaded file:
```json
{ "url": "https://<public-file-url>" }
```

During the initial session negotiation (raw HTTP flow), UploadThing returns a set of fields that include presigned URLs and other metadata; their exact shape may vary by UploadThing version. Use the SDK whenever possible.


## Error Handling
- Invalid API key: middleware throws an error; client receives an error response (status is typically 500 with message "Invalid API key" under current implementation). Consider mapping to 401 in future.
- Missing/invalid headers: uploads still proceed unless an invalid key is explicitly supplied.
- Oversized/unsupported file type: UploadThing will reject and return an error before or during upload.
- Discord webhook failures do not affect the upload success; they are logged server-side only.


## Discord Notifications (optional)
If the environment variable `DISCORD_WEBHOOK_URL` is set, the server will POST an embed containing:
- Filename, extension, size
- Public file URL (also used as image where applicable)
- Deletion timestamp (humanized via Discord timestamp formatting)
- Optional description from `x-description`

Configure the variable in `.env`:
```env
DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/...
```


## Examples

### JavaScript (fetch) — SDK-less simplified init
```ts
const base = "https://<your-domain>/api/uploadthing";

async function initUpload(file: File) {
  const body = {
    files: [{ name: file.name, size: file.size, type: file.type }],
    route: "fileUploader",
  };

  const res = await fetch(base, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-api-key": "<PUBLIC_API_KEY>",
      "x-description": "Uploaded via JS fetch",
    },
    body: JSON.stringify(body),
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json(); // contains presigned data as per UploadThing
}
```

### Node (TypeScript) — final response consumption
```ts
// After the upload completes (via SDK or protocol),
// your app will receive a final response like:
// { url: "https://utfs.io/f/..." }

interface UploadResult { url: string }
function onUploadComplete(data: UploadResult) {
  console.log("Public URL:", data.url);
}
```

### Python (requests) — session init
```python
import requests

base = "https://<your-domain>/api/uploadthing"
payload = {
    "files": [{"name": "doc.pdf", "size": 2048, "type": "application/pdf"}],
    "route": "fileUploader"
}
headers = {
    "Content-Type": "application/json",
    "x-api-key": "<PUBLIC_API_KEY>",
    "x-description": "Uploaded via Python"
}
resp = requests.post(base, json=payload, headers=headers)
resp.raise_for_status()
print(resp.json())
```


## Implementation Notes (for maintainers)
- The UploadThing router is created in `src/app/api/uploadthing/core.ts` via `createUploadthing()` and exported as `ourFileRouter`.
- The Next.js App Router handler in `src/app/api/uploadthing/route.ts` exports `{ GET, POST } = createRouteHandler({ router: ourFileRouter })`.
- Middleware reads `x-api-key` and `x-description`; invalid key throws.
- `onUploadComplete` logs the upload and posts the Discord embed if `DISCORD_WEBHOOK_URL` is set.
- Return shape from `onUploadComplete` is `{ url: file.url }`.


## FAQ
- Can I change the file size limits or types?
  - Yes, update the `image`, `pdf`, `video` constraints in `ourFileRouter.fileUploader` inside `core.ts`.
- How do I add another logical endpoint (e.g., `avatarUploader`)?
  - Add another key to `ourFileRouter` with its own config and reference it via `endpoint="avatarUploader"` in the client.
- How do I require the API key for all uploads?
  - Update the middleware to throw if `!apiKey || apiKey !== PUBLIC_API_KEY`.
- How do I change error status codes?
  - Wrap and translate errors in `createRouteHandler` config or handle them in the client to map to desired UX.


## Changelog
- v1: Initial documentation covering `fileUploader` endpoint, headers, constraints, and examples.
